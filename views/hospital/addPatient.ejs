  <!DOCTYPE html>
  <html lang="en" class="h-full bg-slate-50 antialiased">

  <head>
      <meta charset="UTF-8">
      <title>Register Patient | Smart Health</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">

      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

      <script src="https://cdn.tailwindcss.com"></script>
      <script>
          tailwind.config = {
              theme: {
                  extend: {
                      fontFamily: { sans: ['Inter', 'sans-serif'] },
                      colors: {
                          brand: { 50: '#ecfdf5', 100: '#d1fae5', 500: '#10b981', 600: '#059669', 700: '#047857' },
                          slate: { 850: '#1e293b' }
                      }
                  }
              }
          }
      </script>
  </head>

  <body class="flex flex-col min-h-full text-slate-600">

      <%- include("../partials/navbar", { hospital: hospital || null }) %>

      <main class="flex-grow py-10 px-4 sm:px-6 lg:px-8">

          <div class="max-w-3xl mx-auto mb-6 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
              <nav class="flex items-center space-x-2 text-sm text-slate-500">
                  <a href="/hospital/dashboard" class="hover:text-brand-600 transition-colors">Dashboard</a>
                  <svg class="h-4 w-4 text-slate-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
                  <a href="/hospital/patients" class="hover:text-brand-600 transition-colors">Patients</a>
                  <svg class="h-4 w-4 text-slate-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
                  <span class="text-slate-900 font-semibold bg-slate-100 px-2 py-0.5 rounded text-xs">New Admission</span>
              </nav>

              <a href="/hospital/dashboard" class="inline-flex items-center justify-center px-4 py-2 border border-slate-300 shadow-sm text-xs font-medium rounded-lg text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 transition-all">
                  Cancel
              </a>
          </div>

          <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
              
              <div class="px-6 py-5 border-b border-slate-100 bg-slate-50/50 flex items-start gap-4">
                  <div class="flex-shrink-0 p-2 bg-brand-50 rounded-lg text-brand-600 hidden sm:block">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                  </div>
                  <div>
                      <h3 class="text-lg font-bold leading-6 text-slate-900">Patient Details</h3>
                      <p class="mt-1 text-sm text-slate-500">Search for an existing profile or enter new details to register a visit.</p>
                  </div>
              </div>

              <div class="p-6 sm:p-8">
                  <form action="/hospital/patients" method="POST" class="space-y-6">
                      
                      <input type="hidden" name="profileId" id="profileId">

                      <div class="relative">
                          <label class="block text-sm font-medium text-slate-700 mb-1">Patient Search</label>
                          <div class="relative rounded-md shadow-sm">
                              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                  <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                              </div>
                              <input type="text" 
                              name="name"   id="patientSearch" 
                                  class="block w-full pl-10 pr-3 py-2.5 border border-slate-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 sm:text-sm transition-all placeholder-slate-400" 
                                  placeholder="Start typing name or phone number..." autocomplete="off" required>
                          </div>
                          
                          <div id="searchResults" class="absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-auto hidden">
                              </div>
                      </div>

                      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                          
                          <div>
                              <label class="block text-sm font-medium text-slate-700">Age</label>
                              <input type="number" name="age" id="age" required 
                                  class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 sm:text-sm shadow-sm transition-all">
                          </div>

                          <div>
                              <label class="block text-sm font-medium text-slate-700">Gender</label>
                              <select name="gender" id="gender" required 
                                  class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 sm:text-sm shadow-sm transition-all bg-white">
                                  <option value="">Select...</option>
                                  <option>Male</option>
                                  <option>Female</option>
                                  <option>Other</option>
                              </select>
                          </div>

                          <div>
                              <label class="block text-sm font-medium text-slate-700">Phone</label>
                              <div class="mt-1 relative rounded-md shadow-sm">
                                  <input type="text" name="phone" id="phone" 
                                      class="block w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 sm:text-sm transition-all">
                              </div>
                          </div>
                      </div>

                      <div class="relative py-2">
                          <div class="absolute inset-0 flex items-center" aria-hidden="true">
                              <div class="w-full border-t border-slate-100"></div>
                          </div>
                          <div class="relative flex justify-center">
                              <span class="px-3 bg-white text-xs font-semibold text-slate-400 uppercase tracking-wider">Clinical Information</span>
                          </div>
                      </div>

                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                          <div class="sm:col-span-2">
                              <label class="block text-sm font-medium text-slate-700">Disease / Symptoms / Diagnosis</label>
                              <input type="text" name="disease" required 
                                  class="mt-1 block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 sm:text-sm shadow-sm transition-all"
                                  placeholder="e.g. High Fever, Chest Pain, Viral Infection">
                          </div>

                          <div class="sm:col-span-2">
                              <label class="block text-sm font-medium text-slate-700">Assign Doctor</label>
                              <select name="doctor" class="mt-1 block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 sm:text-sm shadow-sm transition-all bg-white">
                                  <option value="">-- Select Doctor --</option>
                                  <% doctors.forEach(d => { %>
                                      <option value="<%= d._id %>">
                                          Dr. <%= d.name %> (<%= d.specialization %>)
                                      </option>
                                  <% }) %>
                              </select>
                          </div>
                      </div>

                      <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 space-y-4">
                          <div>
                              <label class="block text-sm font-medium text-slate-900">Admission Type</label>
                              <select name="patientType" id="patientType" required 
                                  class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 sm:text-sm shadow-sm transition-all bg-white">
                                  <option value="">Select Type...</option>
                                  <option value="OPD">OPD (Outpatient)</option>
                                  <option value="IPD">IPD (Inpatient / Admitted)</option>
                              </select>
                          </div>

                          <div id="opdInfo" class="hidden flex items-start p-3 bg-blue-50 border border-blue-100 rounded-md">
                              <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                              <p class="text-sm text-blue-700">This patient will be registered for a consultation visit with today's date.</p>
                          </div>

                          <div id="ipdFields" class="hidden pt-2 space-y-4 border-t border-slate-200 mt-4">
                              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                  <div>
                                      <label class="block text-sm font-medium text-slate-700">Bed Category</label>
                                      <select name="bedType" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 sm:text-sm">
                                          <option value="">Select Bed...</option>
                                          <option value="general">General Ward</option>
                                          <option value="icu">ICU</option>
                                          <option value="isolation">Isolation Ward</option>
                                      </select>
                                  </div>
                                  <div>
                                      <label class="block text-sm font-medium text-slate-700">Admission Date</label>
                                      <input type="date" name="admissionDate" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 sm:text-sm">
                                  </div>
                              </div>
                          </div>
                      </div>

                      <div class="pt-4 flex items-center justify-end gap-3 border-t border-slate-100">
                          <a href="/hospital/dashboard" class="px-5 py-2.5 border border-slate-300 shadow-sm text-sm font-medium rounded-lg text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 transition-all">
                              Cancel
                          </a>
                          <button type="submit" class="px-6 py-2.5 border border-transparent shadow-md text-sm font-medium rounded-lg text-white bg-brand-600 hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 transition-all transform hover:-translate-y-0.5">
                              Confirm Registration
                          </button>
                      </div>

                  </form>
              </div>
          </div>
      </main>

      <%- include("../partials/footer") %>

      <script>
          // LOAD PROFILES
          const profiles = <%- JSON.stringify(profiles || []) %>;
          localStorage.setItem("patientProfiles", JSON.stringify(profiles));

          const storedProfiles = JSON.parse(localStorage.getItem("patientProfiles")) || [];

          const searchInput = document.getElementById("patientSearch");
          const resultsBox = document.getElementById("searchResults");
          const profileIdInput = document.getElementById("profileId");

          const ageInput = document.getElementById("age");
          const genderInput = document.getElementById("gender");
          const phoneInput = document.getElementById("phone");

          searchInput.addEventListener("input", () => {
              const q = searchInput.value.toLowerCase();
              resultsBox.innerHTML = "";

              if (q.length < 2) {
                  resultsBox.classList.add("hidden");
                  profileIdInput.value = "";
                  return;
              }

              const matches = storedProfiles.filter(p =>
                  (p.name && p.name.toLowerCase().includes(q)) ||
                  (p.phone && p.phone.includes(q))
              );

              if (matches.length === 0) {
                  resultsBox.classList.add("hidden");
                  profileIdInput.value = "";
                  return;
              }

              matches.slice(0, 5).forEach(p => {
                  const btn = document.createElement("div");
                  btn.className = "cursor-pointer px-4 py-3 hover:bg-slate-50 border-b border-slate-100 last:border-0 flex flex-col transition-colors";
                  btn.innerHTML = `
                      <span class="font-medium text-slate-800 text-sm">${p.name}</span>
                      <span class="text-xs text-slate-500">${p.phone || "No phone"}</span>
                  `;

                  btn.onclick = () => {
                      searchInput.value = p.name;
                      profileIdInput.value = p._id;

                      ageInput.value = p.age || "";
                      genderInput.value = p.gender || "";
                      phoneInput.value = p.phone || "";

                      ageInput.readOnly = true;
                      phoneInput.readOnly = true;
                      genderInput.disabled = true;

                      // Visual feedback for read-only fields
                      [ageInput, phoneInput, genderInput].forEach(el => el.classList.add("bg-slate-100", "text-slate-500"));

                      resultsBox.classList.add("hidden");
                  };

                  resultsBox.appendChild(btn);
              });

              resultsBox.classList.remove("hidden");
          });

          // Unlock fields if user clears search or types new name
          searchInput.addEventListener("change", () => {
              if (!profileIdInput.value) {
                  ageInput.readOnly = false;
                  phoneInput.readOnly = false;
                  genderInput.disabled = false;
                  [ageInput, phoneInput, genderInput].forEach(el => el.classList.remove("bg-slate-100", "text-slate-500"));
              }
          });

          // Hide results when clicking outside
          document.addEventListener('click', function(e) {
              if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
                  resultsBox.classList.add("hidden");
              }
          });

          // OPD / IPD TOGGLE
          const patientType = document.getElementById("patientType");
          const ipdFields = document.getElementById("ipdFields");
          const opdInfo = document.getElementById("opdInfo");

          patientType.addEventListener("change", () => {
              if (patientType.value === "IPD") {
                  ipdFields.classList.remove("hidden");
                  opdInfo.classList.add("hidden");
              } else if (patientType.value === "OPD") {
                  ipdFields.classList.add("hidden");
                  opdInfo.classList.remove("hidden");
              } else {
                  ipdFields.classList.add("hidden");
                  opdInfo.classList.add("hidden");
              }
          });
      </script>

  </body>
  </html>