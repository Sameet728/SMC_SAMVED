<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50 antialiased">

<head>
    <meta charset="UTF-8">
    <title>Prescription | <%= patient.name %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Courier Prime', 'monospace']
                    },
                    colors: {
                        brand: { 50: '#ecfdf5', 100: '#d1fae5', 500: '#10b981', 600: '#059669', 700: '#047857', 900: '#064e3b' },
                        slate: { 850: '#1e293b' }
                    }
                }
            }
        }
    </script>
</head>

<body class="flex flex-col min-h-full text-slate-600">

    <%- include("../partials/navbar", { hospital: hospital || null }) %>

    <main class="flex-grow py-8 px-4 sm:px-6 lg:px-8">
        <div class="max-w-6xl mx-auto">

            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900 tracking-tight">Prescription Management</h1>
                    <p class="text-sm text-slate-500 mt-1">Create and manage medication plans for <span class="font-semibold text-slate-900"><%= patient.name %></span></p>
                </div>
                <div class="flex gap-3">
                    <a href="/hospital/dashboard" class="inline-flex items-center justify-center px-4 py-2 border border-slate-300 shadow-sm text-sm font-medium rounded-lg text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 transition-all">
                        Cancel
                    </a>
                    <button onclick="downloadPDF()" class="inline-flex items-center justify-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-slate-900 hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-all">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Download PDF
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">

                <div class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden" id="pdfArea">
                    <div class="bg-emerald-50/50 p-6 border-b border-dashed border-emerald-100">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-lg font-bold text-brand-800 tracking-tight"><%= hospital.hospitalName %></h2>
                                <p class="text-xs text-brand-600 mt-1 font-medium">Official Medical Prescription</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-slate-500">Date: <span class="font-mono font-bold text-slate-700"><%= new Date().toLocaleDateString() %></span></p>
                                <p class="text-xs text-slate-500 mt-0.5">Dr: <span class="font-medium text-slate-700"><%= patient.doctor ? patient.doctor.name : "Unassigned" %></span></p>
                            </div>
                        </div>

                        <div class="mt-4 pt-4 border-t border-dashed border-emerald-200 grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-xs text-slate-400 uppercase tracking-wide font-bold">Patient Name</span>
                                <p class="font-semibold text-slate-900"><%= patient.name %></p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs text-slate-400 uppercase tracking-wide font-bold">Age / Sex</span>
                                <p class="font-mono text-slate-700"><%= patient.age %> / <%= patient.gender %></p>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 min-h-[400px] relative">
                        <div class="absolute top-6 left-6 text-4xl text-slate-200 font-serif italic font-bold select-none z-0">Rx</div>
                        
                        <div class="relative z-10 pl-12">
                            <% if (patient.prescription && patient.prescription.length > 0) { %>
                                <ul class="space-y-4">
                                    <% patient.prescription.forEach((p, i) => { %>
                                        <li class="flex items-start justify-between border-b border-slate-50 pb-2">
                                            <div>
                                                <p class="font-bold text-slate-800 text-sm"><%= p.medicine.name %></p>
                                                <p class="text-xs text-slate-500 mt-0.5 font-mono">Dosage: <%= p.dosage || "As Directed" %></p>
                                            </div>
                                            <div class="text-right">
                                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-mono font-bold bg-slate-100 text-slate-600">
                                                    Qty: <%= p.quantity %>
                                                </span>
                                            </div>
                                        </li>
                                    <% }) %>
                                </ul>
                            <% } else { %>
                                <div class="flex flex-col items-center justify-center h-40 text-slate-300">
                                    <p class="text-sm italic">No medicines prescribed yet.</p>
                                </div>
                            <% } %>
                        </div>
                    </div>

                    <div class="p-6 border-t border-slate-100 bg-slate-50/30">
                        <div class="flex justify-between items-end">
                            <div class="text-xs text-slate-400">
                                <p>Generated by Smart Health Portal</p>
                                <p>Solapur Municipal Corporation</p>
                            </div>
                            <div class="text-center">
                                <div class="h-10 border-b border-slate-300 w-32 mb-1"></div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Doctor's Signature</p>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 sm:p-8">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Prescribe Medication</h3>
                    
                    <div class="relative mb-6">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                        <input type="text" id="searchBox" onkeyup="filterMedicines()" 
                            class="block w-full pl-10 pr-3 py-2.5 border border-slate-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 sm:text-sm transition-all placeholder-slate-400" 
                            placeholder="Search available medicines...">
                    </div>

                    <form action="/hospital/patients/<%= patient._id %>/prescription" method="POST">
                        <div class="space-y-4 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar" id="medicineList">
                            
                            <% medicines.forEach(m => { %>
                                <div class="medicine-row group p-4 rounded-lg border border-slate-200 hover:border-brand-300 hover:bg-brand-50/30 transition-all" data-name="<%= m.name.toLowerCase() %>">
                                    
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <label class="block text-sm font-bold text-slate-900"><%= m.name %></label>
                                            <span class="text-xs text-slate-500 font-medium">Stock: <%= m.quantity %> units</span>
                                        </div>
                                        <div class="h-5 w-5 rounded-full border border-slate-300 group-hover:border-brand-500 group-hover:bg-brand-500 transition-colors"></div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-slate-500 mb-1">Quantity</label>
                                            <input type="number" name="quantity_<%= m._id %>" min="0" max="<%= m.quantity %>" 
                                                class="block w-full px-2 py-1.5 text-sm border border-slate-300 rounded-md focus:ring-brand-500 focus:border-brand-500 shadow-sm"
                                                placeholder="0">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-500 mb-1">Dosage</label>
                                            <input type="text" name="dosage_<%= m._id %>" 
                                                class="block w-full px-2 py-1.5 text-sm border border-slate-300 rounded-md focus:ring-brand-500 focus:border-brand-500 shadow-sm"
                                                placeholder="e.g. 1-0-1">
                                        </div>
                                    </div>

                                </div>
                            <% }) %>

                        </div>

                        <div class="pt-6 mt-6 border-t border-slate-100">
                            <button type="submit" class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 transition-all transform hover:-translate-y-0.5">
                                Update Prescription
                            </button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </main>

    <%- include("../partials/footer") %>

    <script>
        function filterMedicines() {
            const q = document.getElementById("searchBox").value.toLowerCase();
            document.querySelectorAll(".medicine-row").forEach(row => {
                row.style.display = row.dataset.name.includes(q) ? "" : "none";
            });
        }

        function downloadPDF() {
            const element = document.getElementById("pdfArea");
            const opt = {
                margin: 10,
                filename: 'Prescription_<%= patient.name.replace(" ", "_") %>.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }
    </script>

</body>
</html>